# ระบบประเมินคุณภาพอากาศในห้องเรียน

โปรเจคนี้เป็นระบบสำหรับติดตามและประเมินคุณภาพอากาศในห้องเรียน โดยใช้ ESP32 ในการรับข้อมูลจากเซ็นเซอร์ (CO, SO2, อุณหภูมิ, ความชื้น) และส่งไปยัง HTTP server เพื่อวิเคราะห์และบันทึกลงฐานข้อมูล MongoDB

## ส่วนประกอบของระบบ

1. **Arduino (ESP32)** - ทำหน้าที่อ่านค่าจากเซ็นเซอร์และส่งไปยัง HTTP server
2. **HTTP Server** - รับข้อมูลจาก ESP32 ประมวลผลด้วยโมเดล ML และบันทึกลง MongoDB
3. **โมเดล ML** - ทำนายคุณภาพอากาศจากค่าที่รับมาจากเซ็นเซอร์

## ไฟล์ที่สำคัญ

- `arduino_from_sensor.ino` - โค้ด Arduino สำหรับ ESP32
- `http_to_mongo.py` - HTTP server สำหรับรับข้อมูลและบันทึกลง MongoDB
- `data_cleaner.py` - สคริปต์สำหรับทำความสะอาดข้อมูล
- `train_model_rf.py` - สคริปต์สำหรับเทรนโมเดล Random Forest
- `random_forest_model.joblib` - โมเดลที่เทรนแล้ว
- `model_columns.json` - คอลัมน์ที่ใช้ในโมเดล
- `.env` - ไฟล์สำหรับตั้งค่าการเชื่อมต่อ MongoDB และตำแหน่งไฟล์โมเดล
- `requirements.txt` - รายการไลบรารีที่จำเป็น

## ขั้นตอนการติดตั้ง

### ส่วน HTTP Server (Python)

1. ติดตั้ง Python 3.8 หรือสูงกว่า

2. สร้าง virtual environment:
   ```
   python -m venv venv
   source venv/bin/activate  # สำหรับ Linux/Mac
   venv\Scripts\activate     # สำหรับ Windows
   ```

3. ติดตั้งไลบรารีที่จำเป็น:
   ```
   pip install -r requirements.txt
   ```

4. ไฟล์ `.env` มีค่าการตั้งค่าดังนี้ (สามารถใช้ได้เลย):
   ```
   # MongoDB Cloud Settings
   MONGO_URI=mongodb+srv://edwardbat00147:O5DrPGWlRuaUKU4g@aqi-senors-rf.xk5y8sk.mongodb.net/
   MONGO_DB=air_quality_db
   MONGO_COLLECTION=sensor_readings


   # Model Settings
   MODEL_PATH=random_forest_model.joblib
   MODEL_COLUMNS_PATH=model_columns.json
   ```

### ส่วน Arduino (ESP32)

1. ติดตั้ง Arduino IDE

2. ติดตั้งบอร์ด ESP32 ใน Arduino IDE:
   - เลือกเมนู File > Preferences
   - เพิ่ม URL ต่อไปนี้ในช่อง "Additional Boards Manager URLs":
     `https://dl.espressif.com/dl/package_esp32_index.json`
   - ไปที่เมนู Tools > Board > Boards Manager
   - ค้นหา "ESP32" และติดตั้ง

3. ติดตั้งไลบรารีที่จำเป็น:
   - WiFi
   - HTTPClient
   - SoftwareSerial
   - LiquidCrystal

4. แก้ไขไฟล์ `arduino_from_sensor.ino`:
   - ตั้งค่า SSID และรหัสผ่าน WiFi:
     ```cpp
     const char* ssid = "your_SSID";       // แก้ไขเป็น SSID ของ WiFi ที่ใช้
     const char* password = "your_PASSWORD"; // แก้ไขเป็นรหัสผ่าน WiFi ที่ใช้
     ```
   - แก้ไข IP Address ของ HTTP server ในบรรทัดนี้:
     ```cpp
     const String backendURL = "http://192.168.74.14:5001/savedata"; // แก้ไขเป็น IP ของเครื่องที่รัน HTTP server
     ```

   ### วิธีการหา IP Address ของเครื่องที่รัน HTTP Server

   สิ่งที่สำคัญมากคือต้องแก้ไข IP Address ในตัวแปร `backendURL` ให้ตรงกับ IP Address ของเครื่องที่รัน HTTP server (ไฟล์ `http_to_mongo.py`) เพื่อให้ ESP32 สามารถส่งข้อมูลไปยัง server ได้

   #### การหา IP Address บนระบบปฏิบัติการต่างๆ

   **Windows:**
   1. กดปุ่ม `Win + R` เพื่อเปิด Run dialog
   2. พิมพ์ `cmd` แล้วกด Enter
   3. ในหน้าต่าง Command Prompt พิมพ์คำสั่ง `ipconfig` แล้วกด Enter
   4. มองหาส่วนที่เป็น "IPv4 Address" ภายใต้การเชื่อมต่อที่ใช้งานอยู่ (มักเป็น "Wireless LAN adapter Wi-Fi" หรือ "Ethernet adapter")
   5. ตัวอย่าง IP Address จะอยู่ในรูปแบบ: `192.168.1.5`

   **macOS:**
   1. คลิกที่เมนู Apple (รูปแอปเปิ้ล) > System Preferences > Network
   2. เลือกการเชื่อมต่อที่ใช้งานอยู่ (เช่น Wi-Fi หรือ Ethernet)
   3. IP Address จะแสดงอยู่ที่ด้านขวา
   4. หรือเปิด Terminal และพิมพ์คำสั่ง `ifconfig | grep "inet "` แล้วมองหา IP ที่ขึ้นต้นด้วย 192.168 หรือ 10. (ไม่ใช่ 127.0.0.1)

   **Linux:**
   1. เปิด Terminal
   2. พิมพ์คำสั่ง `ip addr` หรือ `ifconfig`
   3. มองหา IP Address ที่อยู่หลัง "inet" ภายใต้การเชื่อมต่อที่ใช้งานอยู่ (เช่น wlan0 สำหรับ Wi-Fi หรือ eth0 สำหรับ Ethernet)

   #### การทดสอบว่า IP Address ถูกต้อง

   1. หลังจากรัน HTTP server ด้วยคำสั่ง `python http_to_mongo.py`
   2. เปิดเว็บเบราว์เซอร์บนเครื่องที่รัน ESP32 (หรือเครื่องอื่นในเครือข่ายเดียวกัน) 
   3. ป้อน URL: `http://[IP-ADDRESS]:5001` (แทนที่ [IP-ADDRESS] ด้วย IP ที่คุณพบ) 
   4. ถ้าเห็นข้อความแสดงว่าไม่พบหน้าเพจหรือ 404 Not Found แสดงว่า IP ถูกต้องและเข้าถึง server ได้ (เพราะไม่มีหน้าหลักที่พาธ `/` แต่มีเฉพาะพาธ `/savedata` สำหรับรับข้อมูล)

   #### ข้อควรระวังเกี่ยวกับ IP Address

   1. **IP Address ภายในเครือข่าย**: ในตัวอย่างนี้ คือ `192.168.74.14` เป็น IP ภายในเครือข่ายเดียวกัน (Local IP) หากใช้งานนอกเครือข่ายจะไม่สามารถเข้าถึงได้
   2. **IP Address อาจเปลี่ยนแปลง**: หากเครื่องที่รัน HTTP server รีสตาร์ทหรือเชื่อมต่อกับเครือข่ายอื่น IP อาจเปลี่ยนไป ควรตรวจสอบทุกครั้งเมื่อเริ่มใช้งาน
   3. **การตั้งค่า Static IP**: เพื่อหลีกเลี่ยงปัญหา IP เปลี่ยนบ่อย อาจตั้งค่า Static IP ให้กับเครื่องที่รัน HTTP server
   4. **หากใช้ในเครื่องเดียวกันทั้งหมด**: สามารถใช้ `localhost` หรือ `127.0.0.1` แทน IP Address ได้

   #### ตัวอย่างการแก้ไข backendURL

   หลังจากหา IP Address ได้แล้ว (สมมติว่าเป็น 192.168.1.100) ให้แก้ไขบรรทัดนี้:

   ```cpp
   // ก่อนแก้ไข
   const String backendURL = "http://192.168.74.14:5001/savedata";

   // หลังแก้ไข
   const String backendURL = "http://192.168.1.100:5001/savedata";
   ```

   หมายเหตุ: อย่าลืมว่าต้องคงส่วน `:5001/savedata` ไว้เหมือนเดิม เปลี่ยนแค่ส่วน IP Address เท่านั้น

5. อัปโหลดโค้ดไปยัง ESP32

## ขั้นตอนการใช้งาน

1. **เตรียมข้อมูลและเทรนโมเดล** (ถ้าต้องการเทรนโมเดลใหม่):
   ```
   python data_cleaner.py   # ทำความสะอาดข้อมูล
   python train_model_rf.py # เทรนโมเดล
   ```

2. **รัน HTTP Server**:
   ```
   python http_to_mongo.py
   ```

3. **เชื่อมต่อ ESP32**:
   - เชื่อมต่อเซ็นเซอร์ MQ7 (CO) เข้ากับขา A0 ของ ESP32
   - เชื่อมต่อเซ็นเซอร์ MQ135 (SO2) เข้ากับขา A1 ของ ESP32
   - เชื่อมต่อ LCD 16x2 เข้ากับขาที่กำหนดในโค้ด
   - ให้ไฟกับ ESP32

4. ระบบจะเริ่มทำงานโดยอัตโนมัติ:
   - ESP32 จะอ่านค่าจากเซ็นเซอร์ทุก 3 วินาที
   - ส่งข้อมูลไปยัง HTTP server
   - HTTP server จะประมวลผลและบันทึกข้อมูลลง MongoDB

## โครงสร้างการส่งข้อมูล

ESP32 จะส่งข้อมูลในรูปแบบ JSON ไปยัง HTTP server:

```json
{
  "temperature": 25.0,
  "humidity": 60.0,
  "co": 10.5,
  "so2": 0.3
}
```

## โครงสร้างข้อมูลที่บันทึกใน MongoDB

ข้อมูลที่บันทึกลงในฐานข้อมูล MongoDB มีโครงสร้างดังนี้:

```json
{
  "timestamp": "2023-04-01T20:15:30.123Z",  // เวลาที่บันทึกข้อมูล (ISO format)
  "date": "2023-04-01",                     // วันที่บันทึกข้อมูล
  "time": "20:15:30",                       // เวลาที่บันทึกข้อมูล
  "sensor_data": {                          // ข้อมูลดิบจากเซ็นเซอร์
    "temperature": 25.0,                    // อุณหภูมิ (°C)
    "humidity": 60.0,                       // ความชื้น (%)
    "co": 10.5,                             // ค่า CO (ppm)
    "so2": 0.3,                             // ค่า SO2 (ppm)
    "timestamp": "2023-04-01T20:15:30.123Z" // เวลาที่รับข้อมูล
  },
  "prediction": {                           // ผลการประเมินคุณภาพอากาศ
    "aqi_class": 0,                         // ระดับคุณภาพอากาศ (0-4)
    "aqi_label": "คุณภาพดีมาก (0-25 μg/m³)", // คำอธิบายระดับคุณภาพอากาศ
    "health_risk": "ความเสี่ยงต่ำมาก: คุณภาพอากาศในห้องเรียนยอดเยี่ยม เอื้อต่อการเรียนรู้และพัฒนาการของนักเรียน ไม่มีผลกระทบต่อสมาธิหรือประสิทธิภาพการเรียนรู้", // ความเสี่ยงต่อสุขภาพ
    "health_recommendation": "ดำเนินกิจกรรมในห้องเรียนได้ตามปกติ สภาพแวดล้อมเหมาะสมที่สุดสำหรับการเรียนการสอนทุกรูปแบบ", // คำแนะนำด้านสุขภาพ
    "probabilities": {                      // ความน่าจะเป็นของแต่ละระดับคุณภาพอากาศ
      "class_0": 0.9,                       // ความน่าจะเป็นของระดับ 0 (คุณภาพดีมาก)
      "class_1": 0.05,                      // ความน่าจะเป็นของระดับ 1 (คุณภาพดี)
      "class_2": 0.03,                      // ความน่าจะเป็นของระดับ 2 (ปานกลาง)
      "class_3": 0.01,                      // ความน่าจะเป็นของระดับ 3 (เริ่มมีผลกระทบต่อสุขภาพ)
      "class_4": 0.01                       // ความน่าจะเป็นของระดับ 4 (มีผลกระทบต่อสุขภาพ)
    },
    "method": "direct",                     // วิธีการประเมินคุณภาพอากาศ (direct, model, hybrid_edge, pm25_override, consistent, fallback)
    "pm25_value": null,                     // ค่า PM2.5 (ถ้ามี)
    "key_sensors": {                        // ค่าจากเซ็นเซอร์หลัก
      "temperature": 25.0,                  // อุณหภูมิ (°C)
      "humidity": 60.0                      // ความชื้น (%)
    }
  }
}
```

### รายละเอียดฟิลด์ที่สำคัญ

1. **timestamp, date, time**: เวลาที่บันทึกข้อมูล

2. **sensor_data**: ข้อมูลดิบจากเซ็นเซอร์
   - **temperature**: อุณหภูมิในหน่วย °C
   - **humidity**: ความชื้นในหน่วย %
   - **co**: ค่า Carbon Monoxide ในหน่วย ppm
   - **so2**: ค่า Sulfur Dioxide ในหน่วย ppm

3. **prediction**: ผลการประเมินคุณภาพอากาศ
   - **aqi_class**: ระดับคุณภาพอากาศ (0-4)
     - 0: คุณภาพดีมาก (0-25 μg/m³)
     - 1: คุณภาพดี (26-37 μg/m³)
     - 2: ปานกลาง (38-50 μg/m³)
     - 3: เริ่มมีผลกระทบต่อสุขภาพ (51-90 μg/m³)
     - 4: มีผลกระทบต่อสุขภาพ (91+ μg/m³)
   - **aqi_label**: คำอธิบายระดับคุณภาพอากาศ
   - **health_risk**: ความเสี่ยงต่อสุขภาพตามระดับคุณภาพอากาศ
   - **health_recommendation**: คำแนะนำด้านสุขภาพตามระดับคุณภาพอากาศ
   - **probabilities**: ความน่าจะเป็นของแต่ละระดับคุณภาพอากาศ (0-4)
   - **method**: วิธีการประเมินคุณภาพอากาศ
     - **direct**: ใช้ค่า PM2.5 โดยตรง
     - **model**: ใช้โมเดล ML
     - **hybrid_edge**: ผสมระหว่างค่า PM2.5 และโมเดล ML
     - **pm25_override**: ค่า PM2.5 มีความสำคัญเหนือกว่าโมเดล ML
     - **consistent**: ค่า PM2.5 และโมเดล ML ให้ผลตรงกัน
     - **fallback**: ไม่มีข้อมูล PM2.5 และโมเดลมีปัญหา ใช้ค่าเริ่มต้น
   - **pm25_value**: ค่า PM2.5 (ถ้ามี)
   - **key_sensors**: ข้อมูลจากเซ็นเซอร์หลัก (temperature, humidity, co2)

## ระดับคุณภาพอากาศ (Thai AQI)

ระบบใช้เกณฑ์คุณภาพอากาศของประเทศไทย:

| ระดับ | คำอธิบาย | ค่า PM2.5 (μg/m³) |
|------|---------|-----------------|
| 0 | คุณภาพดีมาก | 0-25 |
| 1 | คุณภาพดี | 26-37 |
| 2 | ปานกลาง | 38-50 |
| 3 | เริ่มมีผลกระทบต่อสุขภาพ | 51-90 |
| 4 | มีผลกระทบต่อสุขภาพ | 91+ |

## การแก้ปัญหา

- **ESP32 ไม่สามารถเชื่อมต่อ WiFi ได้**: ตรวจสอบ SSID และรหัสผ่าน
- **ESP32 ไม่สามารถเชื่อมต่อกับ HTTP server ได้**: ตรวจสอบ IP Address และพอร์ตของ HTTP server
- **HTTP server ไม่สามารถเชื่อมต่อกับ MongoDB ได้**: ตรวจสอบการเชื่อมต่ออินเทอร์เน็ต หรือรีสตาร์ทระบบ 